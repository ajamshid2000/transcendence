###########################################################
# ft_transcendence - NGINX Gateway
# - HTTPS frontend (443)
# - Proxy vers frontend (web:3000)
# - Proxy vers backend API (backend:4000)
# - WebSockets (/ws/)
# - Monitoring (Grafana, Prometheus)
###########################################################


#############################
# HTTP -> HTTPS
#############################
server {
    listen 80;
    server_name localhost 10.12.2.7;

    # Redirection permanente vers HTTPS (port 443 du gateway)
    return 301 https://$host:8443$request_uri;
}

#############################
# REDIRECTION PORT 4000 -> /api
#############################
# server {
#     listen 4000;
#     server_name localhost ;

#     # Redirection permanente vers HTTPS (port 443 du gateway)
#     return 301 https://$host:8443/api$request_uri;
# }

#############################
# SERVEUR HTTPS PRINCIPAL
#############################
server {

    #######################################################
    # Écoute HTTPS
    #######################################################
    listen 443 ssl;
    server_name localhost 10.12.2.7;

    # Certificats montés depuis ./certs dans le container
    ssl_certificate     /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;

    # (Optionnel) durcissement SSL basique
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    #######################################################
    # Endpoint de santé (utilisé par le healthcheck Docker)
    # GET https://10.12.2.7/health -> 200 OK
    #######################################################
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    #######################################################
    # FRONTEND (SPA / Vite)
    # - Sert tout ce qui n'est pas /api, /ws, /grafana, /prometheus
    # - Redirigé vers le service "web" sur le port 3000
    #######################################################
    location / {
        proxy_pass http://web:3000/;
        proxy_http_version 1.1;

        # WebSocket + HMR Vite + éventuels WS front
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # Headers classiques de reverse proxy
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    #######################################################
    # BACKEND API
    # - Toutes les routes /api/... sont proxifiées vers backend:4000/api/...
    # - Le backend ne voit que le chemin après /api/
    #######################################################
    location /api/ {
        proxy_pass http://backend:4000/api/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    #######################################################
    # WEBSOCKETS BACKEND
    # - Pour ton Pong, ton chat ou tout WS côté backend
    # - Exemple: ws://10.12.2.7/ws/
    #######################################################
    location /ws/ {
        proxy_pass http://backend:4000/;
        proxy_http_version 1.1;

        # Indispensable pour les WebSockets
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";

        # Headers classiques
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    #######################################################
    # GRAFANA
    # - Accès via https://10.12.2.7/grafana/ ou https://10.12.2.7:5000/
    # - Ton service Grafana écoute sur 5000 dans le réseau Docker
    #   (GF_SERVER_HTTP_PORT=5000, ports 5000:5000 dans docker-compose)
    #
    # ⚠ Pour un vrai subpath /grafana :
    #    - dans Grafana :
    #        GF_SERVER_ROOT_URL = https://10.12.2.7/grafana/
    #        GF_SERVER_SERVE_FROM_SUB_PATH = true
    #######################################################
    location /grafana/ {
        proxy_pass http://grafana:5000/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    #######################################################
    # PROMETHEUS
    # - Accès via https://10.12.2.7/prometheus/
    # - Optionnel, mais pratique pour dev/monitoring
    #######################################################
    location /prometheus/ {
        proxy_pass http://prometheus:9090/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    #######################################################
    # PAGES D'ERREUR
    #######################################################
    error_page 502 503 504 /50x.html;

    location = /50x.html {
        return 500 "Internal Server Error";
    }
}